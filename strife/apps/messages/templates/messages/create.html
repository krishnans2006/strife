{% block script %}
<script>
  function processMessageKeydown(input) {
      if (event.key === 'Enter') {
          event.preventDefault();
          sendSocketMessage();
      }
  }

  $(document).ready(() => {
      const uploadButton = document.getElementById('upload-attachment');
      const fileStorage = document.getElementById('attachments');
      const fileDisplay = document.getElementById('attachments-view');

      const uploadedFiles = [];

      // When the upload button is clicked
      uploadButton.addEventListener('click', () => {
          fileStorage.click();
      });

      // When a file is uploaded
      fileStorage.addEventListener('change', () => {
          console.log(fileStorage.files);

          // Update the list of uploaded files
          for (let i = 0; i < fileStorage.files.length; i++) {
              const file = fileStorage.files[i];
              const fileIndex = uploadedFiles.findIndex((f) => f.name === file.name);

              if (fileIndex === -1) {
                  uploadedFiles.push(file);
              } else {
                  uploadedFiles.splice(fileIndex, 1);
                  uploadedFiles.push(file);
              }
          }

          // Update the file display
          fileDisplay.innerHTML = '';
          uploadedFiles.forEach((file) => {
              const fileElement = document.createElement('a');
              fileElement.href = URL.createObjectURL(file);
              fileElement.target = '_blank';
              fileElement.className = 'inline-block min-w-20 py-1 px-2.5 rounded-xl bg-gray-700 text-white cursor-pointer';
              fileElement.innerText = file.name;
              fileDisplay.appendChild(fileElement);
          });
      });
  });
</script>
{% endblock script %}

<div id="send-message" class="flex flex-col w-full p-4 pt-0">
  <div id="attachments-view"></div>
  <label class="basis-full flex flex-row bg-gray-800 rounded-xl items-center">
    <span id="upload-attachment" class="mx-3.5 size-7 flex-none aspect-square object-cover rounded-3xl bg-gray-700 text-white flex items-center justify-center cursor-pointer">
      <span class="text-2xl pb-0.5">+</span>
    </span>
    <input type="text" id="content" class="w-full px-4 pr-2 pl-0 bg-gray-800 rounded-r-xl text-white border-transparent focus:border-transparent focus:ring-0" placeholder="Message {{ channel.name }}" autocomplete="off" onkeydown="processMessageKeydown(this);">
    <input type="file" multiple id="attachments" class="hidden" />
  </label>
</div>
