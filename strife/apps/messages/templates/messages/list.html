{% block script %}
  <script>
    // Scroll to bottom
    $(document).ready(() => {
      const messageList = $('#message-list')[0];
      messageList.scrollTop = messageList.scrollHeight;
    });

    // WebSockets
    const socket = new WebSocket(`ws://{{ request.get_host }}/servers/{{ server.id }}/channels/{{ channel.id }}/messages/ws/`);

    socket.onopen = function(e) {
        console.log('Message socket connected');
    }

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const message = data.message;

        const messageList = $('#message-list-div')[0];
        messageList.innerHTML += `
          <div class="w-full px-5 py-1 justify-center flex flex-row gap-3.5">
            <img class="size-10 flex-none aspect-square object-cover rounded-full mt-1" src="${message.author.display_avatar}" alt="${message.author.username}">
            <div class="grow text-gray-300 flex flex-col">
              <h4 class="text-lg font-bold">${message.author.username}</h4>
              <p>${message.content}</p>
            </div>
          </div>
        `;
    }

    socket.onclose = function(e) {
        console.error('Message socket closed unexpectedly');
    }

    function sendSocketMessage() {
      let contentInput = $('#send-message #content')[0];

      if (contentInput.value) {
          contentInput.disabled = true;

          let data = {
              content: contentInput.value,
              attachments: [],
          };

          if (uploadedFiles.length > 0) {
              // Use FileReader and ArrayBuffer to send files
              for (let i = 0; i < uploadedFiles.length; i++) {
                  const file = uploadedFiles[i];
                  const reader = new FileReader();

                  reader.onload = function (e) {
                      const arrayBuffer = e.target.result;

                      data.attachments.push({
                          name: file.name,
                          type: file.type,
                          size: file.size,
                          data: arrayBuffer,
                      });
                  };

                  reader.readAsArrayBuffer(file);

                  uploadedFiles = [];
                  $('#attachments-view').empty();

              }
          }

          socket.send(JSON.stringify(data));

          contentInput.value = '';
          contentInput.disabled = false;
          contentInput.focus();
      }
    }

    // Used in messages/create.html
    // And in sendSocketMessage()
    let uploadedFiles = [];
  </script>
{% endblock script %}

<div class="flex flex-col h-dvh max-h-dvh">
  <!-- Header -->
  <div class="flex-none px-4 py-1 text-gray-300 flex flex-row items-center bg-gray-700 border-l-2 border-gray-600">
    <div class="divide-x flex flex-row items-center">
      <h1 class="text-2xl font-bold inline-block">{{ channel.name }}</h1>
      <h3 class="text-lg inline-block ml-3 pl-2.5">{{ channel.description }}</h3>
    </div>
  </div>

  <!-- Messages -->
  <div id="message-list" class="grow overflow-y-auto pb-3 flex flex-col">
    <div class="grow"></div>
    <div id="message-list-div" class="flex flex-col">
      {% for message in channel.messages.all %}
        {% include 'messages/detail.html' %}
      {% endfor %}
    </div>
  </div>

  <!-- Send Message -->
  {% include 'messages/create.html' %}
</div>
