{% block script %}
  <script>
    // Scroll to bottom
    window.onload = function() {
      let messageList = document.getElementById('message-list');
      messageList.scrollTop = messageList.scrollHeight;
    }

    // WebSockets
    const socket = new WebSocket(`ws://{{ request.get_host }}/servers/{{ server.id }}/channels/{{ channel.id }}/messages/ws/`);

    socket.onopen = function(e) {
        console.log('Message socket connected');
    }

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const message = data.message;

        const messageList = document.getElementById('message-list');
        messageList.innerHTML += `
          <div class="w-full px-5 py-1 justify-center flex flex-row gap-3.5">
            <img class="size-10 flex-none aspect-square object-cover rounded-full mt-1" src="${message.author.display_avatar}" alt="${message.author.username}">
            <div class="grow text-gray-300 flex flex-col">
              <h4 class="text-lg font-bold">${message.author.username}</h4>
              <p>${message.content}</p>
            </div>
          </div>
        `;
    }

    socket.onclose = function(e) {
        console.error('Message socket closed unexpectedly');
    }

    function sendSocketMessage() {
      let contentInput = document.querySelector('#send-message #content');

      if (contentInput.value) {
          contentInput.disabled = true;

          let data = {
              content: contentInput.value,
          };

          socket.send(JSON.stringify(data));

          contentInput.value = '';
          contentInput.disabled = false;
          contentInput.focus();
      }
    }
  </script>
{% endblock script %}

<div class="flex flex-col h-dvh max-h-dvh">
  <!-- Header -->
  <div class="flex-none px-4 py-1 text-gray-300 flex flex-row items-center bg-gray-700 border-l-2 border-gray-600">
    <div class="divide-x flex flex-row items-center">
      <h1 class="text-2xl font-bold inline-block">{{ channel.name }}</h1>
      <h3 class="text-lg inline-block ml-3 pl-2.5">{{ channel.description }}</h3>
    </div>
  </div>

  <!-- Messages -->
  <div id="message-list" class="grow overflow-y-auto pb-3 flex flex-col justify-end">
    {% for message in channel.messages.all %}
      <div class="w-full px-5 py-1 justify-center flex flex-row gap-3.5 flex-none max-h-50">
        <img class="size-10 flex-none aspect-square object-cover rounded-full mt-1" src="{{ message.author.display_avatar }}" alt="{{ message.author.username }}">
        <div class="grow text-gray-300 flex flex-col">
          <h4 class="text-lg font-bold">{{ message.author.username }}</h4>
          <p>{{ message.content }}</p>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Send Message -->
  {% include 'messages/create.html' %}
</div>
