{% block script %}
  <script>
    // Scroll to bottom
    $(document).ready(() => {
      const messageList = $('#message-list')[0];
      messageList.scrollTop = messageList.scrollHeight;
    });

    // WebSockets
    const socket = new WebSocket(`ws://{{ request.get_host }}/servers/{{ server.id }}/channels/{{ channel.id }}/messages/ws/`);

    socket.onopen = function(e) {
        console.log('Message socket connected');
    }

    function addMessage(message) {
        const messageList = $('#message-list-div')[0];

        // Any updates here should also be done to messages/detail.html
        messageList.innerHTML += `
          <div id="message-${message.id}" class="w-full px-5 py-1 justify-center flex flex-row gap-3.5">
            <img class="size-10 flex-none aspect-square object-cover rounded-full mt-1" src="${message.author.display_avatar}" alt="${message.author.username}">
            <div id="message-${message.id}-child" class="grow text-gray-300 flex flex-col">
              <h4 class="text-lg font-bold">${message.author.username}</h4>
              <p>${message.content}</p>

              ${message.attachments.length > 0 ? `
                <div id="message-${message.id}-attachments" class="flex flex-row gap-3.5">
                  ${message.attachments.map((attachment) => `
                    <a href="${attachment.download_url}" target="_blank" class="inline-block min-w-20 py-1 px-2.5 rounded-xl bg-gray-700 text-white cursor-pointer">${attachment.name}</a>
                  `).join('')}
                </div>
              ` : ''}
            </div>
          </div>
        `;

        lastMessage = message;
    }

    function updateAttachments(message) {
        const messageDiv = $(`#message-${message.id}`)[0];
        const messageChildDiv = $(`#message-${message.id}-child`)[0];
        const attachmentsDiv = $(`#message-${message.id}-attachments`)[0];

        if (attachmentsDiv) {
            attachmentsDiv.innerHTML = message.attachments.map((attachment) => `
                <a href="${attachment.download_url}" target="_blank" class="inline-block min-w-20 py-1 px-2.5 rounded-xl bg-gray-700 text-white cursor-pointer">${attachment.name}</a>
            `).join('');
        } else {
            messageChildDiv.innerHTML += `
                <div id="message-${message.id}-attachments" class="flex flex-row gap-3.5">
                    ${message.attachments.map((attachment) => `
                        <a href="${attachment.download_url}" target="_blank" class="inline-block min-w-20 py-1 px-2.5 rounded-xl bg-gray-700 text-white cursor-pointer">${attachment.name}</a>
                    `).join('')}
                </div>
            `;
        }
    }

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        if (data.type === 'message') {
            addMessage(data.message);
        } else if (data.type === 'attachment') {
            updateAttachments(data.message);
        }
    }

    socket.onclose = function(e) {
        console.error('Message socket closed unexpectedly');
    }

    function sendFile(fileObj, fileData, messageID) {
        const fileMetadata = JSON.stringify({
            name: fileObj.name,
            type: fileObj.type,
            size: fileObj.size,
            messageID: messageID,
        });

        const enc = new TextEncoder();
        const prefix = enc.encode('!file!');
        const metadata = enc.encode(fileMetadata);
        const separator = enc.encode('!');
        const data = fileData;

        let toSend = new Uint8Array(prefix.byteLength + metadata.byteLength + separator.byteLength + data.byteLength);
        toSend.set(new Uint8Array(prefix), 0);
        toSend.set(new Uint8Array(metadata), prefix.byteLength);
        toSend.set(new Uint8Array(separator), prefix.byteLength + metadata.byteLength);
        toSend.set(new Uint8Array(data), prefix.byteLength + metadata.byteLength + separator.byteLength);

        socket.binaryType = 'arraybuffer';
        socket.send(toSend);
        socket.binaryType = 'blob';
    }

    function sendSocketAttachments() {
        if (uploadedFiles.length > 0) {
            // Use FileReader and ArrayBuffer to send files
            for (let i = 0; i < uploadedFiles.length; i++) {
                const file = uploadedFiles[i];
                const reader = new FileReader();

                reader.onload = function (e) {
                    let rawData = new ArrayBuffer();
                    rawData = e.target.result;

                    sendFile(file, rawData, lastMessage.id);
                };

                reader.readAsArrayBuffer(file);
            }

            uploadedFiles = [];
            $('#attachments-view').empty();
        }
    }

    function sendSocketMessage() {
      let contentInput = $('#send-message #content')[0];

      if (contentInput.value) {
          contentInput.disabled = true;

          let data = {
              content: contentInput.value,
          };

          lastMessageIDBeforeSend = lastMessage ? lastMessage.id : -1;

          socket.send(JSON.stringify(data));

          function waitForMessageUpdateThenUploadAttachments() {
              if (lastMessageIDBeforeSend === (lastMessage ? lastMessage.id : -1) || lastMessage.author.id !== {{ request.user.id }}) {
                  setTimeout(waitForMessageUpdateThenUploadAttachments, 100);
                  return;
              }
              console.log("!");
              sendSocketAttachments();
          }

          waitForMessageUpdateThenUploadAttachments();

          contentInput.value = '';
          contentInput.disabled = false;
          contentInput.focus();
      }
    }

    // Used in messages/create.html
    // And in sendSocketMessage()
    let uploadedFiles = [];

    // Stores the most recent message
    let lastMessage = null;
  </script>
{% endblock script %}

<div class="flex flex-col h-dvh max-h-dvh">
  <!-- Header -->
  <div class="flex-none px-4 py-1 text-gray-300 flex flex-row items-center bg-gray-700 border-l-2 border-gray-600">
    <div class="divide-x flex flex-row items-center">
      <h1 class="text-2xl font-bold inline-block">{{ channel.name }}</h1>
      <h3 class="text-lg inline-block ml-3 pl-2.5">{{ channel.description }}</h3>
    </div>
  </div>

  <!-- Messages -->
  <div id="message-list" class="grow overflow-y-auto pb-3 flex flex-col">
    <div class="grow"></div>
    <div id="message-list-div" class="flex flex-col">
      {% for message in channel.messages.all %}
        {% include 'messages/detail.html' %}
      {% endfor %}
    </div>
  </div>

  <!-- Send Message -->
  {% include 'messages/create.html' %}
</div>
